---
title: "Bayesian Final Project"
output: pdf_document
date: "2026-01-23"
---

```{r data_import}
#| message: false

library(readxl)
library(dplyr)
library(tidyr)
library(lubridate)
library(stringr)
```

```{r}
load("beatspy.RData")
```

# Revised Frequentist Models
The mixed-effects models are likely overfitting (`boundary (singular) fit` issue)

```{r}
#logistic regression models fitted within each sector
library(purrr)
library(modelsummary)

sector_models = m3_df |>
  group_split(gics_sector_name) |>
  setNames(unique(m3_df$gics_sector_name)) |>
  map(~ glm(
    beat_spy ~ log_pe + div_yield,
    data = .x,
    family = binomial(link = "logit")
  ))

modelsummary(sector_models)

```

```{r}
#mixed-effects w/ firm-level random intercepts
library(lme4)
mixed_intercept = glmer(
  beat_spy ~ log_pe + div_yield + 
    (1 | Ticker),
  data = m3_df,
  family = binomial(link = "logit")
)
mixed_intercept |> summary()
```

```{r}
#mixed effects w/ firm-level random slopes
mixed_random_slopes = glmer(
  beat_spy ~ log_pe + div_yield +
    (1 + log_pe + div_yield | Ticker),
  data = m3_df,
  family = binomial(link = "logit"),
  control = glmerControl(optimizer = "bobyqa")
)

mixed_random_slopes |> summary()
```

```{r}
#mixed-effects model w/ sector-level random slopes
mixed_sector_slopes = glmer(
  beat_spy ~ log_pe + div_yield +
    (1 + log_pe + div_yield | gics_sector_name),
  data = m3_df,
  family = binomial(link = "logit")
)

mixed_sector_slopes |> summary()
```

```{r}
#mixed-effects model with sector-level variation + firm-level variation within sector
mixed_nested = glmer(
  beat_spy ~ log_pe + div_yield +
    (1 | gics_sector_name/Ticker),
  data = m3_df,
  family = binomial(link = "logit")
)

mixed_nested |> summary()
```

## Bayesian Analysis
```{r}
#| message: false
library(brms)
library(tidybayes)
library(bayesplot)
library(posterior)
```

### Model 1 (Logistic)

\begin{align*}
Y_{i,t} \sim Bernoulli(p_{i,t})\\
logit(p_{i,t}) = \beta_0 + \beta_1 + log(PE_{i,t}) + \beta_2 DivYield_{i,t}
\end{align*}

```{r}
#| results: hide
bayes_model1 <- brm(
  beat_spy ~ log_pe + div_yield,
  data = m3_df,
  family = bernoulli(link = "logit"),
  seed = 123
)
```

```{r}
summary(bayes_model1)$fixed
```

```{r}
draws_model1 = bayes_model1 |>
  as_draws_array()

mcmc_trace(draws_model1,
           pars = c("b_log_pe", "b_div_yield", "b_Intercept"))
```

```{r}
mcmc_acf_bar(
  draws_model1,
  pars = c("b_log_pe", "b_div_yield", "b_Intercept")
)
```

## Model 2 (Hierarchical)

```{r}
#| results: hide
bayes_model2 <- brm(
  beat_spy ~ log_pe + div_yield + (1 | gics_sector_name/Ticker),
  data = m3_df,
  family = bernoulli(link = "logit"),
  seed = 123
)
```

```{r}
summary(bayes_model2)
```

```{r}
draws_model2 = bayes_model2 |>
  as_draws_array()

mcmc_trace(
  draws_model2,
  pars = c("b_log_pe",
           "b_div_yield",
           "b_Intercept",
           "sd_gics_sector_name__Intercept",
           "sd_gics_sector_name:Ticker__Intercept")
)
```

```{r}
mcmc_acf_bar(
  draws_model2,
  pars = c("b_log_pe", "b_div_yield", "b_Intercept", "sd_gics_sector_name__Intercept", "sd_gics_sector_name:Ticker__Intercept")
)
```

### Model Comparison
```{r}
loo_compare(loo(bayes_model1),
            loo(bayes_model2))
```

The difference in expected log predictive density is 22.2 (SE = 7.0). LOOCV provides strong evidence that the multilevel specification improves out-of-sample predictive performance.