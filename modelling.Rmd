---
title: "Final Project - Bayesian Analysis"
output: pdf_document
---

```{r data_import}
#| message: false

library(readxl)
library(dplyr)
library(tidyr)
library(lubridate)
library(stringr)
```

```{r}
load("beatspy.RData")
```

```{r}
#| message: false
library(brms)
library(tidybayes)
library(bayesplot)
library(posterior)
```

### Model 1 (Logistic)

\begin{align*}
Y_{i,t} \sim Bernoulli(p_{i,t})\\
logit(p_{i,t}) = \beta_0 + \beta_1 + log(PE_{i,t}) + \beta_2 DivYield_{i,t}
\end{align*}

```{r}
#| results: hide
bayes_model1 <- brm(
  beat_spy ~ log_pe + div_yield,
  data = m3_df,
  family = bernoulli(link = "logit"),
  seed = 123
)
```

```{r}
summary(bayes_model1)$fixed
```

Rhats are ~1 and effective sample sizes >> 100

```{r}
draws_model1 = bayes_model1 |>
  as_draws_array()

mcmc_trace(draws_model1,
           pars = c("b_log_pe", "b_div_yield", "b_Intercept"))
```

No discernable pattern from trace plots

```{r}
mcmc_acf_bar(
  draws_model1,
  pars = c("b_log_pe", "b_div_yield", "b_Intercept")
)
```

acfs fall off quickly

## Model 2 (Hierarchical)

(including both sector and firm-level random intercepts)

\begin{align*}
logit(p_{i,t}) = \beta_0 + \beta_1 log(PE_{i,t}) + \beta_2 DivYield_{i,t} + u_{j} + v_i
\end{align*}

```{r}
#| results: hide
bayes_model2 <- brm(
  beat_spy ~ log_pe + div_yield + (1 | gics_sector_name/Ticker),
  data = m3_df,
  family = bernoulli(link = "logit"),
  seed = 123
)
```

```{r}
summary(bayes_model2)
```

Rhats are all ~1, effective sample sizes >> 100

```{r}
draws_model2 = bayes_model2 |>
  as_draws_array()

mcmc_trace(
  draws_model2,
  pars = c("b_log_pe",
           "b_div_yield",
           "b_Intercept",
           "sd_gics_sector_name__Intercept",
           "sd_gics_sector_name:Ticker__Intercept")
)
```

```{r}
mcmc_acf_bar(
  draws_model2,
  pars = c("b_log_pe", "b_div_yield", "b_Intercept", "sd_gics_sector_name__Intercept", "sd_gics_sector_name:Ticker__Intercept")
)
```

acfs fall off quickly

### Model Comparison
```{r}
loo_compare(loo(bayes_model1),
            loo(bayes_model2))
```

The difference in expected log predictive density is 22.2 (SE = 7.0). LOOCV provides strong evidence that the multilevel specification improves out-of-sample predictive performance.