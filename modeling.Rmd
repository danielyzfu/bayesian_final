---
title: "Final Project - Bayesian Analysis"
output: pdf_document
---

```{r data_import}
#| message: false

library(readxl)
library(dplyr)
library(tidyr)
library(lubridate)
library(stringr)
library(lme4)
library(tidymodels)
library(purrr)
library(tidyr)
library(pROC)
library(groupdata2)
```

```{r}
load("beatspy.RData")
m3_df = m3_df |>
  mutate(
    beat_spy = factor(
      beat_spy,
      levels = c(1, 0),      # 1 = event
      labels = c("yes", "no")
    ),
    gics_sector_name = factor(gics_sector_name),
    Ticker = factor(Ticker)
  )
set.seed(123)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Frequentist

## Models

### Sector Models

```{r}
#logistic regression models fitted within each sector
library(purrr)
library(modelsummary)

sector_models = m3_df |>
  group_split(gics_sector_name) |>
  setNames(unique(m3_df$gics_sector_name)) |>
  map(~ glm(
    beat_spy ~ log_pe + div_yield,
    data = .x,
    family = binomial(link = "logit")
  ))

modelsummary(sector_models)

```

### Firm Mixed Effects
```{r}
#mixed effects w/ firm-level random slopes
mixed_random_slopes = glmer(
  beat_spy ~ log_pe + div_yield +
    (1 + log_pe + div_yield | Ticker),
  data = m3_df,
  family = binomial(link = "logit"),
  control = glmerControl(optimizer = "bobyqa")
)

mixed_random_slopes |> summary()
```

### Sector Fixed Effects
```{r}
#pooled logistic model w sector fixed effects
pooled_fe = glm(
  beat_spy ~ log_pe + div_yield + factor(gics_sector_name),
  data = m3_df,
  family = binomial(link = "logit")
)

summary(pooled_fe)
```

### Sector Fixed Effects w/ Interactions
```{r}
#pooled logistic model w sector fe + interactions with DivYield
pooled_fe_interact = glm(
  beat_spy ~ 
    log_pe +
    div_yield * factor(gics_sector_name),
  data = m3_df,
  family = binomial(link = "logit")
)

summary(pooled_fe_interact)
```

## Model Comparison

### Information Criterion

```{r}
# manually back out AIC + BIC
# AIC = -2l + 2k
# BIC = -2l + log(n) * k 

sector_logLik = sum(sapply(sector_models, logLik))
sector_k = sum(sapply(sector_models, function(m) attr(logLik(m), "df")))

sector_AIC = -2 * as.numeric(sector_logLik) + 2 * sector_k
sector_BIC = -2 * as.numeric(sector_logLik) + 
              log(nrow(m3_df)) * sector_k

# AIC
aic_comp = AIC(pooled_fe,
               pooled_fe_interact,
               mixed_random_slopes)
aic_comp = data.frame(
  Model = rownames(aic_comp),
  df = aic_comp$df,
  AIC = aic_comp$AIC,
  row.names = NULL
) |>
  rbind(data.frame(Model = "sector_models",
                   df = sector_k,
                   AIC = sector_AIC))

#BIC
bic_comp = BIC(pooled_fe,
               pooled_fe_interact,
               mixed_random_slopes)
bic_comp = data.frame(
  Model = rownames(bic_comp),
  df = bic_comp$df,
  BIC = bic_comp$BIC,
  row.names = NULL
) |>
  rbind(data.frame(Model = "sector_models",
                   df = sector_k,
                   BIC = sector_BIC))
```

```{r}
aic_comp |> arrange(AIC)
bic_comp |> arrange(BIC)
```

### Predictive Performance
```{r}
cv_df <- m3_df %>% fold(k = 10, cat_col = "gics_sector_name")

folds <- unique(cv_df$.folds)

cv_results <- map_dfr(folds, function(f){
  
  train <- filter(cv_df, .folds != f)
  test  <- filter(cv_df, .folds == f)
  
  # Mixed-effects logistic regression
  mixed_mod <- glmer(
    beat_spy ~ log_pe + div_yield + (1 + log_pe + div_yield | Ticker),
    data = train,
    family = binomial,
    control = glmerControl(optimizer = "bobyqa")
  )
  mixed_pred <- predict(mixed_mod, newdata = test, type = "response", re.form = NA)
  
  # Pooled FE
  pooled_mod <- glm(
    beat_spy ~ log_pe + div_yield + factor(gics_sector_name),
    data = train,
    family = binomial
  )
  pooled_pred <- predict(pooled_mod, newdata = test, type = "response")
  
  # Pooled FE + interaction
  pooled_int_mod <- glm(
    beat_spy ~ log_pe + div_yield * factor(gics_sector_name),
    data = train,
    family = binomial
  )
  pooled_int_pred <- predict(pooled_int_mod, newdata = test, type = "response")
  
  # Sector-by-sector
  sector_preds <- test %>%
    group_by(gics_sector_name) %>%
    group_modify(~ {
      sect_train <- filter(train, gics_sector_name == .y$gics_sector_name)
      mod <- glm(beat_spy ~ log_pe + div_yield, data = sect_train, family = binomial)
      tibble(pred = predict(mod, newdata = .x, type = "response"))
    }) %>%
    pull(pred)
  
  tibble(
    Ticker = test$Ticker,
    true = test$beat_spy,
    mixed = mixed_pred,
    pooled = pooled_pred,
    pooled_int = pooled_int_pred,
    sector = sector_preds
  )
})

cv_results <- cv_results %>%
  mutate(
    true_bin = ifelse(true == "yes", 1, 0)
  )
```

```{r}
auc_table <- tibble(
  model = c("mixed", "pooled", "pooled_int", "sector_by_sector"),
  auc = c(
    auc(cv_results$true, cv_results$mixed),
    auc(cv_results$true, cv_results$pooled),
    auc(cv_results$true, cv_results$pooled_int),
    auc(cv_results$true, cv_results$sector)
  )
)

auc_table |> arrange(desc(auc))
```

# Bayesian

```{r}
#| message: false
library(brms)
library(tidybayes)
library(bayesplot)
library(posterior)
```

### Model 1 (Logistic)

\begin{align*}
Y_{i,t} \sim Bernoulli(p_{i,t})\\
logit(p_{i,t}) = \beta_0 + \beta_1 + log(PE_{i,t}) + \beta_2 DivYield_{i,t}
\end{align*}

```{r}
#| results: hide
bayes_model1 = brm(
  beat_spy ~ log_pe + div_yield,
  data = m3_df,
  family = bernoulli(link = "logit"),
  seed = 123
)
```

```{r}
summary(bayes_model1)$fixed
```

Rhats are ~1 and effective sample sizes >> 100

```{r}
draws_model1 = bayes_model1 |>
  as_draws_array()

mcmc_trace(draws_model1,
           pars = c("b_log_pe", "b_div_yield", "b_Intercept"))
```

No discernable pattern from trace plots

```{r}
mcmc_acf_bar(
  draws_model1,
  pars = c("b_log_pe", "b_div_yield", "b_Intercept")
)
```

acfs fall off quickly

## Model 2 (Nested random intercepts)

\begin{align*}
logit(p_{i,t}) = \beta_0 + \beta_1 log(PE_{i,t}) + \beta_2 DivYield_{i,t} + u_{j} + v_i
\end{align*}

```{r}
#| results: hide
bayes_model2 = brm(
  beat_spy ~ log_pe + div_yield + (1 | gics_sector_name/Ticker),
  data = m3_df,
  family = bernoulli(link = "logit"),
  seed = 123
)
```

```{r}
summary(bayes_model2)
```

Rhats are all ~1, effective sample sizes >> 100

```{r}
draws_model2 = bayes_model2 |>
  as_draws_array()

mcmc_trace(
  draws_model2,
  pars = c("b_log_pe",
           "b_div_yield",
           "b_Intercept",
           "sd_gics_sector_name__Intercept",
           "sd_gics_sector_name:Ticker__Intercept")
)
```

```{r}
mcmc_acf_bar(
  draws_model2,
  pars = c("b_log_pe", "b_div_yield", "b_Intercept", "sd_gics_sector_name__Intercept", "sd_gics_sector_name:Ticker__Intercept")
)
```

acfs fall off quickly

### Model 3 (Mixed Effects + firm-level random slopes/intercepts)

Covariates are centered

```{r}
#| results: hide
bayes_model3 = brm(
  beat_spy ~ log_pe + div_yield + (1 + log_pe + div_yield | Ticker),
  data = m3_df |> mutate(log_pe = scale(log_pe),
                         div_yield = scale(div_yield)),
  family = bernoulli(link = "logit"),
  seed = 123
)
```

```{r}
summary(bayes_model3)
```

Rhats are ~1 and effective sample sizes >> 100

```{r}
draws_bayes_mixed = bayes_model3 |>
  as_draws_array()

mcmc_trace(draws_bayes_mixed,
           pars = c("b_log_pe", "b_div_yield", "b_Intercept","sd_Ticker__Intercept", "sd_Ticker__log_pe", "sd_Ticker__div_yield"))
```

No discernable pattern from trace plots

```{r}
mcmc_acf_bar(
  draws_bayes_mixed,
  pars = c("b_log_pe", "b_div_yield", "b_Intercept","sd_Ticker__Intercept", "sd_Ticker__log_pe", "sd_Ticker__div_yield"))
```

### Model 4 (Pooled + sector FE)

```{r}
#| results: hide
bayes_fe = brm(
  beat_spy ~ log_pe + div_yield + factor(gics_sector_name),
  data = m3_df,
  family = bernoulli(link = "logit"),
  seed = 123
)
```

```{r}
summary(bayes_fe)
```

Rhats are ~1 and effective sample sizes >> 100

```{r}
draws_bayes_fe = bayes_fe |>
  as_draws_array()

mcmc_trace(draws_bayes_fe,
           pars = c("b_log_pe", "b_div_yield", "b_Intercept","b_factorgics_sector_nameInformationTechnology"))
```

No discernable pattern from trace plots

```{r}
mcmc_acf_bar(
  draws_bayes_fe,
  pars = c("b_log_pe", "b_div_yield", "b_Intercept","b_factorgics_sector_nameInformationTechnology")
)
```

### Model Comparison
```{r}
loo_compare(loo(bayes_model1),
            loo(bayes_model2),
            loo(bayes_model3),
            loo(bayes_fe))
```

LOOCV favors the `pooled model with sector fixed effects` and the `model with nested random intercepts` over the `baseline pooled model` and `mixed effects model w/ firm-level random intercepts and slopes`.

The sector FE and nested random intercepts models are generally comparable (firm-level variation may be small)