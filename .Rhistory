library(lme4)
mixed_intercept = glmer(
beat_spy ~ log_pe + div_yield +
(1 | Ticker),
data = m3_df,
family = binomial(link = "logit")
)
mixed_intercept |> summary()
#mixed effects w/ firm-level random slopes
mixed_random_slopes = glmer(
beat_spy ~ log_pe + div_yield +
(1 + log_pe + div_yield | Ticker),
data = m3_df,
family = binomial(link = "logit"),
control = glmerControl(optimizer = "bobyqa")
)
mixed_random_slopes |> summary()
#pooled logistic model w sector fixed effects
pooled_fe = glm(
beat_spy ~ log_pe + div_yield + factor(gics_sector_name),
data = m3_df,
family = binomial(link = "logit")
)
summary(pooled_fe)
#pooled logistic model w sector fe + interactions with DivYield
pooled_fe_interact = glm(
beat_spy ~
log_pe * factor(gics_sector_name) +
div_yield * factor(gics_sector_name),
data = m3_df,
family = binomial(link = "logit")
)
summary(pooled_fe_interact)
#pooled logistic model w sector fe + interactions with DivYield
pooled_fe_interact = glm(
beat_spy ~
log_pe +
div_yield * factor(gics_sector_name),
data = m3_df,
family = binomial(link = "logit")
)
summary(pooled_fe_interact)
#logistic regression models fitted within each sector
library(purrr)
library(modelsummary)
sector_models = m3_df |>
group_split(gics_sector_name) |>
setNames(unique(m3_df$gics_sector_name)) |>
map(~ glm(
beat_spy ~ log_pe + div_yield,
data = .x,
family = binomial(link = "logit")
))
modelsummary(sector_models)
View(mixed_intercept)
AIC(pooled_fe,
pooled_fe_interact
)
AIC(mixed_intercept,
mixed_random_slopes)
#have to manually back out aic + bic
sector_logLik = sum(sapply(sector_models, logLik))
sector_k = sum(sapply(sector_models, function(m) attr(logLik(m), "df")))
sector_AIC = -2 * as.numeric(sector_logLik) + 2 * sector_k
sector_BIC = -2 * as.numeric(sector_logLik) +
log(nrow(m3_df)) * sector_k
#have to manually back out aic + bic
sector_logLik = sum(sapply(sector_models, logLik))
sector_k = sum(sapply(sector_models, function(m) attr(logLik(m), "df")))
sector_AIC = -2 * as.numeric(sector_logLik) + 2 * sector_k
sector_BIC = -2 * as.numeric(sector_logLik) +
log(nrow(m3_df)) * sector_k
sector_AIC
AIC(pooled_fe,
pooled_fe_interact)
AIC(pooled_fe,
pooled_fe_interact) |> colnames()
AIC(pooled_fe,
pooled_fe_interact) |>
rbind(AIC(mixed_intercept,
mixed_random_slopes))
#have to manually back out AIC + BIC
# AIC = 2l + 2k
# BIC = 2l + log(n) * k
sector_logLik = sum(sapply(sector_models, logLik))
sector_k = sum(sapply(sector_models, function(m) attr(logLik(m), "df")))
sector_AIC = -2 * as.numeric(sector_logLik) + 2 * sector_k
sector_BIC = -2 * as.numeric(sector_logLik) +
log(nrow(m3_df)) * sector_k
AIC_comparison = AIC(pooled_fe,
pooled_fe_interact) |>
rbind(AIC(mixed_intercept,
mixed_random_slopes)) |>
rbind(as.data.frame(sector_AIC))
#have to manually back out AIC + BIC
# AIC = 2l + 2k
# BIC = 2l + log(n) * k
sector_logLik = sum(sapply(sector_models, logLik))
sector_k = sum(sapply(sector_models, function(m) attr(logLik(m), "df")))
sector_AIC = -2 * as.numeric(sector_logLik) + 2 * sector_k
sector_BIC = -2 * as.numeric(sector_logLik) +
log(nrow(m3_df)) * sector_k
AIC_comparison = AIC(pooled_fe,
pooled_fe_interact) |>
rbind(AIC(mixed_intercept,
mixed_random_slopes))
AIC_comparison$Model = rownames(AIC_comparison)
AIC_comparison
View(sector_models)
#have to manually back out AIC + BIC
# AIC = 2l + 2k
# BIC = 2l + log(n) * k
sector_logLik = sum(sapply(sector_models, logLik))
sector_k = sum(sapply(sector_models, function(m) attr(logLik(m), "df")))
sector_AIC = -2 * as.numeric(sector_logLik) + 2 * sector_k
sector_BIC = -2 * as.numeric(sector_logLik) +
log(nrow(m3_df)) * sector_k
aic_comp = AIC(pooled_fe,
pooled_fe_interact) |>
rbind(AIC(mixed_intercept,
mixed_random_slopes))
aic_comp = data.frame(
Model = rownames(aic_comp),
df = aic_comp$df,
AIC = aic_comp$AIC,
row.names = NULL
) |>
rbind(data.frame(Model = "sector_models",
AIC = sector_AIC))
#have to manually back out AIC + BIC
# AIC = 2l + 2k
# BIC = 2l + log(n) * k
sector_logLik = sum(sapply(sector_models, logLik))
sector_k = sum(sapply(sector_models, function(m) attr(logLik(m), "df")))
sector_AIC = -2 * as.numeric(sector_logLik) + 2 * sector_k
sector_BIC = -2 * as.numeric(sector_logLik) +
log(nrow(m3_df)) * sector_k
aic_comp = AIC(pooled_fe,
pooled_fe_interact) |>
rbind(AIC(mixed_intercept,
mixed_random_slopes))
aic_comp = data.frame(
Model = rownames(aic_comp),
df = aic_comp$df,
AIC = aic_comp$AIC,
row.names = NULL
) |>
rbind(data.frame(Model = "sector_models",
df = sector_k
AIC = sector_AIC))
#have to manually back out AIC + BIC
# AIC = 2l + 2k
# BIC = 2l + log(n) * k
sector_logLik = sum(sapply(sector_models, logLik))
sector_k = sum(sapply(sector_models, function(m) attr(logLik(m), "df")))
sector_AIC = -2 * as.numeric(sector_logLik) + 2 * sector_k
sector_BIC = -2 * as.numeric(sector_logLik) +
log(nrow(m3_df)) * sector_k
aic_comp = AIC(pooled_fe,
pooled_fe_interact) |>
rbind(AIC(mixed_intercept,
mixed_random_slopes))
aic_comp = data.frame(
Model = rownames(aic_comp),
df = aic_comp$df,
AIC = aic_comp$AIC,
row.names = NULL
) |>
rbind(data.frame(Model = "sector_models",
df = sector_k,
AIC = sector_AIC))
aic_comp
#have to manually back out AIC + BIC
# AIC = 2l + 2k
# BIC = 2l + log(n) * k
sector_logLik = sum(sapply(sector_models, logLik))
sector_k = sum(sapply(sector_models, function(m) attr(logLik(m), "df")))
sector_AIC = -2 * as.numeric(sector_logLik) + 2 * sector_k
sector_BIC = -2 * as.numeric(sector_logLik) +
log(nrow(m3_df)) * sector_k
aic_comp = AIC(pooled_fe,
pooled_fe_interact) |>
rbind(AIC(mixed_intercept,
mixed_random_slopes))
aic_comp = data.frame(
Model = rownames(aic_comp),
df = aic_comp$df,
AIC = aic_comp$AIC,
row.names = NULL
) |>
rbind(data.frame(Model = "sector_models",
df = sector_k,
AIC = sector_AIC))
aic_comp |> sort(AIC)
#have to manually back out AIC + BIC
# AIC = 2l + 2k
# BIC = 2l + log(n) * k
sector_logLik = sum(sapply(sector_models, logLik))
sector_k = sum(sapply(sector_models, function(m) attr(logLik(m), "df")))
sector_AIC = -2 * as.numeric(sector_logLik) + 2 * sector_k
sector_BIC = -2 * as.numeric(sector_logLik) +
log(nrow(m3_df)) * sector_k
aic_comp = AIC(pooled_fe,
pooled_fe_interact) |>
rbind(AIC(mixed_intercept,
mixed_random_slopes))
aic_comp = data.frame(
Model = rownames(aic_comp),
df = aic_comp$df,
AIC = aic_comp$AIC,
row.names = NULL
) |>
rbind(data.frame(Model = "sector_models",
df = sector_k,
AIC = sector_AIC))
aic_comp |> order(AIC)
aic_comp |> arrange(AIC)
# manually back out AIC + BIC
# AIC = 2l + 2k
# BIC = 2l + log(n) * k
sector_logLik = sum(sapply(sector_models, logLik))
sector_k = sum(sapply(sector_models, function(m) attr(logLik(m), "df")))
sector_AIC = -2 * as.numeric(sector_logLik) + 2 * sector_k
sector_BIC = -2 * as.numeric(sector_logLik) +
log(nrow(m3_df)) * sector_k
# AIC
aic_comp = AIC(pooled_fe,
pooled_fe_interact) |>
rbind(AIC(mixed_intercept,
mixed_random_slopes))
aic_comp = data.frame(
Model = rownames(aic_comp),
df = aic_comp$df,
AIC = aic_comp$AIC,
row.names = NULL
) |>
rbind(data.frame(Model = "sector_models",
df = sector_k,
AIC = sector_AIC))
#BIC
bic_comp = BIC(pooled_fe,
pooled_fe_interact) |>
rbind(BIC(mixed_intercept,
mixed_random_slopes))
bic_comp = data.frame(
Model = rownames(bic_comp),
df = bic_comp$df,
AIC = bic_comp$BIC,
row.names = NULL
) |>
rbind(data.frame(Model = "sector_models",
df = sector_k,
AIC = sector_BIC))
aic_comp |> arrange(AIC)
bic_comp |> arrange(BIC)
bic_comp
View(bic_comp)
View(bic_comp)
View(bic_comp)
View(aic_comp)
View(bic_comp)
View(aic_comp)
View(bic_comp)
# manually back out AIC + BIC
# AIC = 2l + 2k
# BIC = 2l + log(n) * k
sector_logLik = sum(sapply(sector_models, logLik))
sector_k = sum(sapply(sector_models, function(m) attr(logLik(m), "df")))
sector_AIC = -2 * as.numeric(sector_logLik) + 2 * sector_k
sector_BIC = -2 * as.numeric(sector_logLik) +
log(nrow(m3_df)) * sector_k
# AIC
aic_comp = AIC(pooled_fe,
pooled_fe_interact) |>
rbind(AIC(mixed_intercept,
mixed_random_slopes))
aic_comp = data.frame(
Model = rownames(aic_comp),
df = aic_comp$df,
AIC = aic_comp$AIC,
row.names = NULL
) |>
rbind(data.frame(Model = "sector_models",
df = sector_k,
AIC = sector_AIC))
#BIC
bic_comp = BIC(pooled_fe,
pooled_fe_interact) |>
rbind(BIC(mixed_intercept,
mixed_random_slopes))
bic_comp = data.frame(
Model = rownames(bic_comp),
df = bic_comp$df,
BIC = bic_comp$BIC,
row.names = NULL
) |>
rbind(data.frame(Model = "sector_models",
df = sector_k,
AIC = sector_BIC))
AIC_comparison |> rm()
BIC(pooled_fe,
pooled_fe_interact)
bic_comp |> rm()
# manually back out AIC + BIC
# AIC = 2l + 2k
# BIC = 2l + log(n) * k
sector_logLik = sum(sapply(sector_models, logLik))
sector_k = sum(sapply(sector_models, function(m) attr(logLik(m), "df")))
sector_AIC = -2 * as.numeric(sector_logLik) + 2 * sector_k
sector_BIC = -2 * as.numeric(sector_logLik) +
log(nrow(m3_df)) * sector_k
# AIC
aic_comp = AIC(pooled_fe,
pooled_fe_interact) |>
rbind(AIC(mixed_intercept,
mixed_random_slopes))
aic_comp = data.frame(
Model = rownames(aic_comp),
df = aic_comp$df,
AIC = aic_comp$AIC,
row.names = NULL
) |>
rbind(data.frame(Model = "sector_models",
df = sector_k,
AIC = sector_AIC))
#BIC
bic_comp = BIC(pooled_fe,
pooled_fe_interact) |>
rbind(BIC(mixed_intercept,
mixed_random_slopes))
bic_comp = data.frame(
Model = rownames(bic_comp),
df = bic_comp$df,
BIC = bic_comp$BIC,
row.names = NULL
) |>
rbind(data.frame(Model = "sector_models",
df = sector_k,
AIC = sector_BIC))
# manually back out AIC + BIC
# AIC = 2l + 2k
# BIC = 2l + log(n) * k
sector_logLik = sum(sapply(sector_models, logLik))
sector_k = sum(sapply(sector_models, function(m) attr(logLik(m), "df")))
sector_AIC = -2 * as.numeric(sector_logLik) + 2 * sector_k
sector_BIC = -2 * as.numeric(sector_logLik) +
log(nrow(m3_df)) * sector_k
# AIC
aic_comp = AIC(pooled_fe,
pooled_fe_interact) |>
rbind(AIC(mixed_intercept,
mixed_random_slopes))
aic_comp = data.frame(
Model = rownames(aic_comp),
df = aic_comp$df,
AIC = aic_comp$AIC,
row.names = NULL
) |>
rbind(data.frame(Model = "sector_models",
df = sector_k,
AIC = sector_AIC))
#BIC
bic_comp = BIC(pooled_fe,
pooled_fe_interact) |>
rbind(BIC(mixed_intercept,
mixed_random_slopes))
bic_comp = data.frame(
Model = rownames(bic_comp),
df = bic_comp$df,
BIC = bic_comp$BIC,
row.names = NULL
) |>
rbind(data.frame(Model = "sector_models",
df = sector_k,
BIC = sector_BIC))
aic_comp |> arrange(AIC)
bic_comp |> arrange(BIC)
AIC(sector_models)
bayes_fe = brm(
beat_spy ~ log_pe + div_yield + factor(gics_sector_name),
data = m3_df,
family = bernoulli(link = "logit")
)
summary(bayes_fe)
draws_bayes_fe = bayes_fe |>
as_draws_array()
mcmc_trace(draws_bayes_fe,
pars = c("b_log_pe", "b_div_yield", "b_Intercept","factorgics_sector_nameInformationTechnology"))
draws_bayes_fe = bayes_fe |>
as_draws_array()
mcmc_trace(draws_bayes_fe,
pars = c("b_log_pe", "b_div_yield", "b_Intercept","b_factorgics_sector_nameInformationTechnology"))
mcmc_acf_bar(
draws_bayes_fe,
pars = c("b_log_pe", "b_div_yield", "b_Intercept","b_factorgics_sector_nameInformationTechnology")
)
loo_compare(loo(bayes_model1),
loo(bayes_model2),
loo(bayes_fe))
#| results: hide
bayes_mixed <- brm(
beat_spy ~ log_pe + div_yield + (1 + log_pe + div_yield | Ticker),
data = m3_df,
family = bernoulli(link = "logit"),
seed = 123
)
summary(bayes_mixed)
#| results: hide
bayes_model2 = brm(
beat_spy ~ log_pe + div_yield + (1 | gics_sector_name/Ticker),
data = m3_df,
family = bernoulli(link = "logit"),
seed = 123
)
summary(bayes_model2)
draws_model2 = bayes_model2 |>
as_draws_array()
mcmc_trace(
draws_model2,
pars = c("b_log_pe",
"b_div_yield",
"b_Intercept",
"sd_gics_sector_name__Intercept",
"sd_gics_sector_name:Ticker__Intercept")
)
mcmc_acf_bar(
draws_model2,
pars = c("b_log_pe", "b_div_yield", "b_Intercept", "sd_gics_sector_name__Intercept", "sd_gics_sector_name:Ticker__Intercept")
)
loo_compare(loo(bayes_model1),
loo(bayes_model2),
loo(bayes_fe))
#| results: hide
bayes_model1 <- brm(
beat_spy ~ log_pe + div_yield,
data = m3_df,
family = bernoulli(link = "logit"),
seed = 123
)
loo_compare(loo(bayes_model1),
loo(bayes_model2),
loo(bayes_fe))
bayes_model3 = brm(
beat_spy ~ log_pe + div_yield + (1 + log_pe + div_yield | Ticker),
data = m3_df,
family = bernoulli(link = "logit"),
seed = 123
)
bayes_model3 = brm(
beat_spy ~ log_pe + div_yield + (1 + log_pe + div_yield | Ticker),
data = m3_df |> mutate(log_pe = scale(log_pe),
div_yield = scale(div_yield)),
family = bernoulli(link = "logit"),
seed = 123
)
summary(bayes_model3)
draws_bayes_mixed = bayes_model3 |>
as_draws_array()
mcmc_trace(draws_bayes_mixed,
pars = c("b_log_pe", "b_div_yield", "b_Intercept","sd(Ticker)__Intercept", "sd(Ticker)__log_pe", "sd(Ticker)__div_yield"))
View(bayes_model3)
ranef(bayes_model3)
ranef(bayes_model3)$Ticker[, , "Intercept"] %>%
as.data.frame() %>%
tibble::rownames_to_column(var = "Ticker") |>
ticker_ranef %>%
arrange(Estimate) %>%
slice(c(1,              # most negative
n(),            # most positive
which.min(abs(Estimate)),  # closest to 0 (typical)
which.max(Est.Error))) %>%   # highest uncertainty
pull(Ticker)
ranef(bayes_model3)$Ticker[, , "Intercept"] %>%
as.data.frame() %>%
tibble::rownames_to_column(var = "Ticker") |>
arrange(Estimate) %>%
slice(c(1,              # most negative
n(),            # most positive
which.min(abs(Estimate)),  # closest to 0 (typical)
which.max(Est.Error))) %>%   # highest uncertainty
ranef(bayes_model3)$Ticker[, , "Intercept"] %>%
as.data.frame() %>%
tibble::rownames_to_column(var = "Ticker") |>
arrange(Estimate) %>%
slice(c(1,              # most negative
n(),            # most positive
which.min(abs(Estimate)),  # closest to 0 (typical)
which.max(Est.Error)))
draws_bayes_mixed = bayes_model3 |>
as_draws_array()
mcmc_trace(draws_bayes_mixed,
pars = c("b_log_pe", "b_div_yield", "b_Intercept","sd(TER)__Intercept", "sd(Ticker)__log_pe", "sd(Ticker)__div_yield"))
draws_bayes_mixed = bayes_model3 |>
as_draws_array()
mcmc_trace(draws_bayes_mixed,
pars = c("b_log_pe", "b_div_yield", "b_Intercept","sd(TER)__Intercept", "sd(TER)__log_pe", "sd(TER)__div_yield"))
draws_bayes_mixed = bayes_model3 |>
as_draws_array()
mcmc_trace(draws_bayes_mixed,
pars = c("b_log_pe", "b_div_yield", "b_Intercept","sd_TER__Intercept", "sd_TER__log_pe", "sd_TER__div_yield"))
draws_bayes_mixed
draws_bayes_mixed = bayes_model3 |>
as_draws_array()
mcmc_trace(draws_bayes_mixed,
pars = c("b_log_pe", "b_div_yield", "b_Intercept","sd_Ticker__Intercept", "sd_Ticker__log_pe", "sd_Ticker__div_yield"))
mcmc_acf_bar(
draws_bayes_mixed,
pars = c("b_log_pe", "b_div_yield", "b_Intercept","sd_Ticker__Intercept", "sd_Ticker__log_pe", "sd_Ticker__div_yield"))
loo_compare(loo(bayes_model1),
loo(bayes_model2),
loo(bayes_model3),
loo(bayes_fe))
